<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Our Site</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; font-family:"Courier New", monospace; background:#000; color:#d0d0d0; overflow:hidden; }
#loader { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; font-size:20px; z-index:2000; }
#loader.fade-out { animation:fadeOut 1s forwards; }
@keyframes fadeOut { 0%{opacity:1} 100%{opacity:0; display:none} }
#passwordScreen { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:1500; }
#passwordScreen input { padding:10px; margin-top:10px; background:#111; color:#fff; border:1px solid #333; width:200px; }
#passwordScreen button { margin-top:10px; padding:5px 10px; cursor:pointer; }
header { display:flex; justify-content:space-around; background:#111; padding:10px 0; opacity:0; transition:1s; }
header div { cursor:pointer; padding:5px 15px; border-radius:5px; }
header div.active { background:#222; color:#00ff88; }
#content { width:100%; height:calc(100vh - 50px); opacity:0; transition:1s; }
#map, #todayHistory, #songLog { display:none; height:100%; padding:10px; overflow-y:auto; }
.glow-marker { background:red; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px red,0 0 16px red; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 8px red,0 0 16px red} 50%{box-shadow:0 0 14px red,0 0 28px red} }
#sidePanel { position:absolute; right:-320px; top:0; width:300px; height:100%; background:#0a0a0a; border-left:1px solid #111; overflow-y:auto; padding:10px; transition:0.3s; z-index:1000; }
#sidePanel.active { right:0; }
.toggleBtn { position:absolute; right:20px; top:60px; font-size:12px; cursor:pointer; opacity:0.6; z-index:1000; }
button { background:#222; color:#fff; border:none; padding:5px 10px; cursor:pointer; margin-top:5px; }
input, textarea { width:100%; padding:5px; margin-top:5px; background:#111; border:1px solid #333; color:#fff; font-family:inherit; }
hr { border-color:#222; }
</style>
</head>
<body>

<!-- Loader screen -->
<div id="loader">ACCESSING ARCHIVE...</div>

<!-- Password gate -->
<div id="passwordScreen">
  <div>Enter Access Code</div>
  <input type="password" id="passInput" placeholder="Code...">
  <button onclick="checkPassword()">Enter</button>
  <div id="passError" style="color:red;margin-top:5px;display:none;">Wrong code</div>
</div>

<!-- Tabs -->
<header>
  <div id="tabMap" class="active" onclick="switchTab('map')">Map</div>
  <div id="tabHistory" onclick="switchTab('history')">Today in Music History</div>
  <div id="tabSong" onclick="switchTab('song')">Song Log</div>
</header>

<div id="content">
  <div id="map"></div>
  <div id="todayHistory">
    <h3>Music Fact of the Day</h3>
    <p id="fact">Loading...</p>
  </div>
  <div id="songLog">
    <h3>Song Log</h3>
    <textarea id="songInput" placeholder="Type a song..."></textarea>
    <button onclick="addSong()">Add Song</button>
    <div id="songs"></div>
  </div>
</div>

<div id="sidePanel"></div>
<div class="toggleBtn" onclick="togglePanel()">Archive</div>

<audio id="ambient" autoplay loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/08/04/audio_8d7502f3c3.mp3?filename=dark-ambient-11513.mp3" type="audio/mpeg">
</audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- Password Gate ---
  const SECRET = "fjollabore"; // change your secret
  function checkPassword(){
    const val = document.getElementById("passInput").value;
    if(val === SECRET){
      document.getElementById("passwordScreen").style.display='none';
      startApp();
    } else {
      document.getElementById("passError").style.display='block';
    }
  }

  function startApp(){
    // Fade in header/content
    setTimeout(()=>{document.querySelector('header').style.opacity=1; document.getElementById('content').style.opacity=1;}, 500);
    document.getElementById("loader").classList.add('fade-out');

    // --- Tab system ---
    function switchTab(tab){
      document.getElementById('tabMap').classList.remove('active');
      document.getElementById('tabHistory').classList.remove('active');
      document.getElementById('tabSong').classList.remove('active');
      document.getElementById('tabMap').classList.toggle('active', tab==='map');
      document.getElementById('tabHistory').classList.toggle('active', tab==='history');
      document.getElementById('tabSong').classList.toggle('active', tab==='song');
      document.getElementById('map').style.display = (tab==='map') ? 'block' : 'none';
      document.getElementById('todayHistory').style.display = (tab==='history') ? 'block' : 'none';
      document.getElementById('songLog').style.display = (tab==='song') ? 'block' : 'none';
    }
    window.switchTab = switchTab;

    // --- Map Tab ---
    let logs = JSON.parse(localStorage.getItem("nocturneLogs")) || [];
    const map = L.map('map').setView([41.9981,21.4254],6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{ attribution:'Â© OpenStreetMap contributors' }).addTo(map);
    const icon = L.divIcon({ html:'<div class="glow-marker"></div>', iconSize:[10,10] });
    logs.forEach(log => { createLog(log.lat, log.lng, log.text, log.time); });
    map.on('click', function(e){
      const text = prompt("LOG ENTRY (max 120 chars)");
      if(!text) return;
      const time = new Date().toLocaleString();
      const log = { lat:e.latlng.lat, lng:e.latlng.lng, text, time };
      logs.push(log);
      localStorage.setItem("nocturneLogs", JSON.stringify(logs));
      createLog(e.latlng.lat,e.latlng.lng,text,time);
    });
    function createLog(lat,lng,text,time){
      const marker = L.marker([lat,lng],{icon}).addTo(map);
      marker.bindPopup(`<strong>LOG ENTRY</strong><br>${text}<br/><small>${time}</small>`);
      const panel = document.getElementById("sidePanel");
      panel.innerHTML += `<div>${text}<br/><small>${time}</small><hr/></div>`;
    }
    window.togglePanel = ()=>{document.getElementById("sidePanel").classList.toggle("active");}

    // --- Today in Music History Tab ---
    fetch('https://api.dayinhistory.dev/v1/today/events/')
      .then(res => res.json())
      .then(events => {
        const musicEvents = events.filter(e =>
          /music|song|album|band|concert|composer|opera/i.test(e.text)
        );
        document.getElementById('fact').innerText =
          musicEvents.length > 0 ? musicEvents[0].text :
          "No significant music event recorded for today.";
      })
      .catch(() => {
        document.getElementById('fact').innerText =
          "Unable to load music history today.";
      });

    // --- Song Log Tab ---
    let songs = JSON.parse(localStorage.getItem("nocturneSongs")) || [];
    function renderSongs(){
      const container = document.getElementById("songs");
      container.innerHTML = '';
      songs.forEach(s => container.innerHTML += `<div>${s}<hr/></div>`);
    }
    window.addSong = ()=>{
      const val = document.getElementById("songInput").value.trim();
      if(!val) return;
      songs.push(val);
      localStorage.setItem("nocturneSongs", JSON.stringify(songs));
      document.getElementById("songInput").value='';
      renderSongs();
    }
    renderSongs();

    // --- Default tab ---
    switchTab('map');
  }
</script>
</body>
</html>

